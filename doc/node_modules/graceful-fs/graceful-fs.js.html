<!DOCTYPE html>
<html>
<head>
  <title>graceful-fs.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules\\graceful-fs\\graceful-fs.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>graceful-fs.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">var</span> polyfills = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./polyfills.js'</span>)
<span class="hljs-keyword">var</span> legacy = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./legacy-streams.js'</span>)
<span class="hljs-keyword">var</span> clone = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./clone.js'</span>)

<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)

<span class="hljs-comment">/* istanbul ignore next - node 0.x polyfill */</span>
<span class="hljs-keyword">var</span> gracefulQueue
<span class="hljs-keyword">var</span> previousSymbol

<span class="hljs-comment">/* istanbul ignore else - node 0.x polyfill */</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">Symbol</span> === <span class="hljs-string">'function'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">Symbol</span>.for === <span class="hljs-string">'function'</span>) {
  gracefulQueue = <span class="hljs-built_in">Symbol</span>.for(<span class="hljs-string">'graceful-fs.queue'</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>This is used in testing by future versions</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  previousSymbol = <span class="hljs-built_in">Symbol</span>.for(<span class="hljs-string">'graceful-fs.previous'</span>)
} <span class="hljs-keyword">else</span> {
  gracefulQueue = <span class="hljs-string">'___graceful-fs.queue'</span>
  previousSymbol = <span class="hljs-string">'___graceful-fs.previous'</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">noop</span> (<span class="hljs-params"></span>) </span>{}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">publishQueue</span>(<span class="hljs-params">context, queue</span>) </span>{
  <span class="hljs-built_in">Object</span>.defineProperty(context, gracefulQueue, {
    <span class="hljs-attr">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> queue
    }
  })
}

<span class="hljs-keyword">var</span> debug = noop
<span class="hljs-keyword">if</span> (util.debuglog)
  debug = util.debuglog(<span class="hljs-string">'gfs4'</span>)
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/\bgfs4\b/i</span>.test(process.env.NODE_DEBUG || <span class="hljs-string">''</span>))
  debug = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> m = util.format.apply(util, <span class="hljs-built_in">arguments</span>)
    m = <span class="hljs-string">'GFS4: '</span> + m.split(<span class="hljs-regexp">/\n/</span>).join(<span class="hljs-string">'\nGFS4: '</span>)
    <span class="hljs-built_in">console</span>.error(m)
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Once time initialization</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">if</span> (!fs[gracefulQueue]) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>This queue can be shared by multiple loaded instances</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> queue = global[gracefulQueue] || []
  publishQueue(fs, queue)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Patch fs.close/closeSync to shared queue version, because we need
to retry() whenever a close happens <em>anywhere</em> in the program.
This is essential when multiple graceful-fs instances are
in play at the same time.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  fs.close = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fs$close</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span> (<span class="hljs-params">fd, cb</span>) </span>{
      <span class="hljs-keyword">return</span> fs$close.call(fs, fd, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>This function uses the graceful-fs shared queue</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (!err) {
          resetQueue()
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)
          cb.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)
      })
    }

    <span class="hljs-built_in">Object</span>.defineProperty(close, previousSymbol, {
      <span class="hljs-attr">value</span>: fs$close
    })
    <span class="hljs-keyword">return</span> close
  })(fs.close)

  fs.closeSync = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fs$closeSync</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">closeSync</span> (<span class="hljs-params">fd</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>This function uses the graceful-fs shared queue</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      fs$closeSync.apply(fs, <span class="hljs-built_in">arguments</span>)
      resetQueue()
    }

    <span class="hljs-built_in">Object</span>.defineProperty(closeSync, previousSymbol, {
      <span class="hljs-attr">value</span>: fs$closeSync
    })
    <span class="hljs-keyword">return</span> closeSync
  })(fs.closeSync)

  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/\bgfs4\b/i</span>.test(process.env.NODE_DEBUG || <span class="hljs-string">''</span>)) {
    process.on(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      debug(fs[gracefulQueue])
      <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>).equal(fs[gracefulQueue].length, <span class="hljs-number">0</span>)
    })
  }
}

<span class="hljs-keyword">if</span> (!global[gracefulQueue]) {
  publishQueue(global, fs[gracefulQueue]);
}

<span class="hljs-built_in">module</span>.exports = patch(clone(fs))
<span class="hljs-keyword">if</span> (process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH &amp;&amp; !fs.__patched) {
    <span class="hljs-built_in">module</span>.exports = patch(fs)
    fs.__patched = <span class="hljs-literal">true</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">patch</span> (<span class="hljs-params">fs</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Everything that references the open() function needs to be in here</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  polyfills(fs)
  fs.gracefulify = patch

  fs.createReadStream = createReadStream
  fs.createWriteStream = createWriteStream
  <span class="hljs-keyword">var</span> fs$readFile = fs.readFile
  fs.readFile = readFile
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readFile</span> (<span class="hljs-params">path, options, cb</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'function'</span>)
      cb = options, options = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">return</span> go$readFile(path, options, cb)

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go$readFile</span> (<span class="hljs-params">path, options, cb, startTime</span>) </span>{
      <span class="hljs-keyword">return</span> fs$readFile(path, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err &amp;&amp; (err.code === <span class="hljs-string">'EMFILE'</span> || err.code === <span class="hljs-string">'ENFILE'</span>))
          enqueue([go$readFile, [path, options, cb], err, startTime || <span class="hljs-built_in">Date</span>.now(), <span class="hljs-built_in">Date</span>.now()])
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)
            cb.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)
        }
      })
    }
  }

  <span class="hljs-keyword">var</span> fs$writeFile = fs.writeFile
  fs.writeFile = writeFile
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeFile</span> (<span class="hljs-params">path, data, options, cb</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'function'</span>)
      cb = options, options = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">return</span> go$writeFile(path, data, options, cb)

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go$writeFile</span> (<span class="hljs-params">path, data, options, cb, startTime</span>) </span>{
      <span class="hljs-keyword">return</span> fs$writeFile(path, data, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err &amp;&amp; (err.code === <span class="hljs-string">'EMFILE'</span> || err.code === <span class="hljs-string">'ENFILE'</span>))
          enqueue([go$writeFile, [path, data, options, cb], err, startTime || <span class="hljs-built_in">Date</span>.now(), <span class="hljs-built_in">Date</span>.now()])
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)
            cb.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)
        }
      })
    }
  }

  <span class="hljs-keyword">var</span> fs$appendFile = fs.appendFile
  <span class="hljs-keyword">if</span> (fs$appendFile)
    fs.appendFile = appendFile
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">appendFile</span> (<span class="hljs-params">path, data, options, cb</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'function'</span>)
      cb = options, options = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">return</span> go$appendFile(path, data, options, cb)

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go$appendFile</span> (<span class="hljs-params">path, data, options, cb, startTime</span>) </span>{
      <span class="hljs-keyword">return</span> fs$appendFile(path, data, options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err &amp;&amp; (err.code === <span class="hljs-string">'EMFILE'</span> || err.code === <span class="hljs-string">'ENFILE'</span>))
          enqueue([go$appendFile, [path, data, options, cb], err, startTime || <span class="hljs-built_in">Date</span>.now(), <span class="hljs-built_in">Date</span>.now()])
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)
            cb.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)
        }
      })
    }
  }

  <span class="hljs-keyword">var</span> fs$copyFile = fs.copyFile
  <span class="hljs-keyword">if</span> (fs$copyFile)
    fs.copyFile = copyFile
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copyFile</span> (<span class="hljs-params">src, dest, flags, cb</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> flags === <span class="hljs-string">'function'</span>) {
      cb = flags
      flags = <span class="hljs-number">0</span>
    }
    <span class="hljs-keyword">return</span> go$copyFile(src, dest, flags, cb)

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go$copyFile</span> (<span class="hljs-params">src, dest, flags, cb, startTime</span>) </span>{
      <span class="hljs-keyword">return</span> fs$copyFile(src, dest, flags, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
        <span class="hljs-keyword">if</span> (err &amp;&amp; (err.code === <span class="hljs-string">'EMFILE'</span> || err.code === <span class="hljs-string">'ENFILE'</span>))
          enqueue([go$copyFile, [src, dest, flags, cb], err, startTime || <span class="hljs-built_in">Date</span>.now(), <span class="hljs-built_in">Date</span>.now()])
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)
            cb.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)
        }
      })
    }
  }

  <span class="hljs-keyword">var</span> fs$readdir = fs.readdir
  fs.readdir = readdir
  <span class="hljs-keyword">var</span> noReaddirOptionVersions = <span class="hljs-regexp">/^v[0-5]\./</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readdir</span> (<span class="hljs-params">path, options, cb</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'function'</span>)
      cb = options, options = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">var</span> go$readdir = noReaddirOptionVersions.test(process.version)
      ? <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go$readdir</span> (<span class="hljs-params">path, options, cb, startTime</span>) </span>{
        <span class="hljs-keyword">return</span> fs$readdir(path, fs$readdirCallback(
          path, options, cb, startTime
        ))
      }
      : <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go$readdir</span> (<span class="hljs-params">path, options, cb, startTime</span>) </span>{
        <span class="hljs-keyword">return</span> fs$readdir(path, options, fs$readdirCallback(
          path, options, cb, startTime
        ))
      }

    <span class="hljs-keyword">return</span> go$readdir(path, options, cb)

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fs$readdirCallback</span> (<span class="hljs-params">path, options, cb, startTime</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, files</span>) </span>{
        <span class="hljs-keyword">if</span> (err &amp;&amp; (err.code === <span class="hljs-string">'EMFILE'</span> || err.code === <span class="hljs-string">'ENFILE'</span>))
          enqueue([
            go$readdir,
            [path, options, cb],
            err,
            startTime || <span class="hljs-built_in">Date</span>.now(),
            <span class="hljs-built_in">Date</span>.now()
          ])
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (files &amp;&amp; files.sort)
            files.sort()

          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)
            cb.call(<span class="hljs-keyword">this</span>, err, files)
        }
      }
    }
  }

  <span class="hljs-keyword">if</span> (process.version.substr(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>) === <span class="hljs-string">'v0.8'</span>) {
    <span class="hljs-keyword">var</span> legStreams = legacy(fs)
    ReadStream = legStreams.ReadStream
    WriteStream = legStreams.WriteStream
  }

  <span class="hljs-keyword">var</span> fs$ReadStream = fs.ReadStream
  <span class="hljs-keyword">if</span> (fs$ReadStream) {
    ReadStream.prototype = <span class="hljs-built_in">Object</span>.create(fs$ReadStream.prototype)
    ReadStream.prototype.open = ReadStream$open
  }

  <span class="hljs-keyword">var</span> fs$WriteStream = fs.WriteStream
  <span class="hljs-keyword">if</span> (fs$WriteStream) {
    WriteStream.prototype = <span class="hljs-built_in">Object</span>.create(fs$WriteStream.prototype)
    WriteStream.prototype.open = WriteStream$open
  }

  <span class="hljs-built_in">Object</span>.defineProperty(fs, <span class="hljs-string">'ReadStream'</span>, {
    <span class="hljs-attr">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> ReadStream
    },
    <span class="hljs-attr">set</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) </span>{
      ReadStream = val
    },
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
  })
  <span class="hljs-built_in">Object</span>.defineProperty(fs, <span class="hljs-string">'WriteStream'</span>, {
    <span class="hljs-attr">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> WriteStream
    },
    <span class="hljs-attr">set</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) </span>{
      WriteStream = val
    },
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
  })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>legacy names</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> FileReadStream = ReadStream
  <span class="hljs-built_in">Object</span>.defineProperty(fs, <span class="hljs-string">'FileReadStream'</span>, {
    <span class="hljs-attr">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> FileReadStream
    },
    <span class="hljs-attr">set</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) </span>{
      FileReadStream = val
    },
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
  })
  <span class="hljs-keyword">var</span> FileWriteStream = WriteStream
  <span class="hljs-built_in">Object</span>.defineProperty(fs, <span class="hljs-string">'FileWriteStream'</span>, {
    <span class="hljs-attr">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> FileWriteStream
    },
    <span class="hljs-attr">set</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) </span>{
      FileWriteStream = val
    },
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
  })

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ReadStream</span> (<span class="hljs-params">path, options</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> ReadStream)
      <span class="hljs-keyword">return</span> fs$ReadStream.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>), <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> ReadStream.apply(<span class="hljs-built_in">Object</span>.create(ReadStream.prototype), <span class="hljs-built_in">arguments</span>)
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ReadStream$open</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>
    open(that.path, that.flags, that.mode, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, fd</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">if</span> (that.autoClose)
          that.destroy()

        that.emit(<span class="hljs-string">'error'</span>, err)
      } <span class="hljs-keyword">else</span> {
        that.fd = fd
        that.emit(<span class="hljs-string">'open'</span>, fd)
        that.read()
      }
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">WriteStream</span> (<span class="hljs-params">path, options</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> WriteStream)
      <span class="hljs-keyword">return</span> fs$WriteStream.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>), <span class="hljs-keyword">this</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> WriteStream.apply(<span class="hljs-built_in">Object</span>.create(WriteStream.prototype), <span class="hljs-built_in">arguments</span>)
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">WriteStream$open</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>
    open(that.path, that.flags, that.mode, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, fd</span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        that.destroy()
        that.emit(<span class="hljs-string">'error'</span>, err)
      } <span class="hljs-keyword">else</span> {
        that.fd = fd
        that.emit(<span class="hljs-string">'open'</span>, fd)
      }
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createReadStream</span> (<span class="hljs-params">path, options</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> fs.ReadStream(path, options)
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createWriteStream</span> (<span class="hljs-params">path, options</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> fs.WriteStream(path, options)
  }

  <span class="hljs-keyword">var</span> fs$open = fs.open
  fs.open = open
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span> (<span class="hljs-params">path, flags, mode, cb</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> mode === <span class="hljs-string">'function'</span>)
      cb = mode, mode = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">return</span> go$open(path, flags, mode, cb)

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">go$open</span> (<span class="hljs-params">path, flags, mode, cb, startTime</span>) </span>{
      <span class="hljs-keyword">return</span> fs$open(path, flags, mode, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, fd</span>) </span>{
        <span class="hljs-keyword">if</span> (err &amp;&amp; (err.code === <span class="hljs-string">'EMFILE'</span> || err.code === <span class="hljs-string">'ENFILE'</span>))
          enqueue([go$open, [path, flags, mode, cb], err, startTime || <span class="hljs-built_in">Date</span>.now(), <span class="hljs-built_in">Date</span>.now()])
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)
            cb.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)
        }
      })
    }
  }

  <span class="hljs-keyword">return</span> fs
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enqueue</span> (<span class="hljs-params">elem</span>) </span>{
  debug(<span class="hljs-string">'ENQUEUE'</span>, elem[<span class="hljs-number">0</span>].name, elem[<span class="hljs-number">1</span>])
  fs[gracefulQueue].push(elem)
  retry()
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>keep track of the timeout between retry() calls</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> retryTimer

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>reset the startTime and lastTime to now
this resets the start of the 60 second overall timeout as well as the
delay between attempts so that we'll retry these jobs sooner</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resetQueue</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> now = <span class="hljs-built_in">Date</span>.now()
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; fs[gracefulQueue].length; ++i) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>entries that are only a length of 2 are from an older version, don't
bother modifying those since they'll be retried anyway.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (fs[gracefulQueue][i].length &gt; <span class="hljs-number">2</span>) {
      fs[gracefulQueue][i][<span class="hljs-number">3</span>] = now <span class="hljs-comment">// startTime</span>
      fs[gracefulQueue][i][<span class="hljs-number">4</span>] = now <span class="hljs-comment">// lastTime</span>
    }
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>call retry to make sure we're actively processing the queue</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  retry()
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retry</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>clear the timer and remove it to help prevent unintended concurrency</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  clearTimeout(retryTimer)
  retryTimer = <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">if</span> (fs[gracefulQueue].length === <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">var</span> elem = fs[gracefulQueue].shift()
  <span class="hljs-keyword">var</span> fn = elem[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">var</span> args = elem[<span class="hljs-number">1</span>]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>these items may be unset if they were added by an older graceful-fs</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> err = elem[<span class="hljs-number">2</span>]
  <span class="hljs-keyword">var</span> startTime = elem[<span class="hljs-number">3</span>]
  <span class="hljs-keyword">var</span> lastTime = elem[<span class="hljs-number">4</span>]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>if we don't have a startTime we have no way of knowing if we've waited
long enough, so go ahead and retry this item now</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (startTime === <span class="hljs-literal">undefined</span>) {
    debug(<span class="hljs-string">'RETRY'</span>, fn.name, args)
    fn.apply(<span class="hljs-literal">null</span>, args)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Date</span>.now() - startTime &gt;= <span class="hljs-number">60000</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>it's been more than 60 seconds total, bail now</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    debug(<span class="hljs-string">'TIMEOUT'</span>, fn.name, args)
    <span class="hljs-keyword">var</span> cb = args.pop()
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cb === <span class="hljs-string">'function'</span>)
      cb.call(<span class="hljs-literal">null</span>, err)
  } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>the amount of time between the last attempt and right now</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> sinceAttempt = <span class="hljs-built_in">Date</span>.now() - lastTime
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>the amount of time between when we first tried, and when we last tried
rounded up to at least 1</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> sinceStart = <span class="hljs-built_in">Math</span>.max(lastTime - startTime, <span class="hljs-number">1</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>backoff. wait longer than the total time we've been retrying, but only
up to a maximum of 100ms</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> desiredDelay = <span class="hljs-built_in">Math</span>.min(sinceStart * <span class="hljs-number">1.2</span>, <span class="hljs-number">100</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>it's been long enough since the last retry, do it again</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (sinceAttempt &gt;= desiredDelay) {
      debug(<span class="hljs-string">'RETRY'</span>, fn.name, args)
      fn.apply(<span class="hljs-literal">null</span>, args.concat([startTime]))
    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>if we can't do this job yet, push it to the end of the queue
and let the next iteration check again</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      fs[gracefulQueue].push(elem)
    }
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>schedule our next run if one isn't already scheduled</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (retryTimer === <span class="hljs-literal">undefined</span>) {
    retryTimer = setTimeout(retry, <span class="hljs-number">0</span>)
  }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
